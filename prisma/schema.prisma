generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

//||||||||||||||||##########||||||||||||||||//
//                   USER                   //
//||||||||||||||||##########||||||||||||||||//
model User {
  id                  String              @id @default(uuid())
  name                String?
  email               String              @unique
  role                String              @default("USER") //USER, ADMIN, 
  stripeCustomerId    String?             @unique
  githubUsername      String?             @unique
  subscribed          Boolean             @default(false)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  verified            Boolean             @default(false)
  completedOnboarding Boolean             @default(false)
  authState           String?
  verificationToken   String?
  currentUrl          String?
  courseProgress      CourseProgress[]
  moduleProgress      ModuleProgress[]
  subModuleProgress   SubModuleProgress[]
  lessonProgress      LessonProgress[]
  tests               Test[]
  checkpoints         Checkpoint[]
  projects            Project[]
  badges              Badge[]
  learningHours       LearningTime[]
}

model LearningTime {
  id     String   @id @default(uuid())
  date   DateTime @default(now())
  hours  Float
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId String
}

//||||||||||||||||##########||||||||||||||||//
//                 PROGRESS                 //
//||||||||||||||||##########||||||||||||||||//
model CourseProgress {
  id             String           @id @default(uuid())
  title          String
  slug           String
  score          Int              @default(0)
  status         String           @default("IN_PROGRESS") //IN_PROGRESS, COMPLETED
  users          User[]
  moduleProgress ModuleProgress[]
  project        Project?
}

model ModuleProgress {
  id                String              @id @default(uuid())
  title             String
  slug              String
  premium           Boolean             @default(true)
  score             Int                 @default(0)
  status            String              @default("LOCKED") //LOCKED, IN_PROGRESS, COMPLETED
  order             Int
  courseProgressId  String?
  users             User[]
  courseProgress    CourseProgress?     @relation(fields: [courseProgressId], references: [id], onDelete: Cascade)
  subModuleProgress SubModuleProgress[]
  badges            Badge[]
  test              Test?
  checkpoint        Checkpoint?
}

model SubModuleProgress {
  id               String           @id @default(uuid())
  title            String
  slug             String
  score            Int              @default(0)
  status           String           @default("LOCKED") //LOCKED, IN_PROGRESS, COMPLETED
  order            Int
  moduleProgressId String
  users            User[]
  moduleProgress   ModuleProgress   @relation(fields: [moduleProgressId], references: [id], onDelete: Cascade)
  lessonProgress   LessonProgress[]
  test             Test?
  checkpoint       Checkpoint?
}

model LessonProgress {
  id                  String            @id @default(uuid())
  title               String
  slug                String
  status              String            @default("LOCKED") //LOCKED, IN_PROGRESS, COMPLETED
  subModuleProgressId String
  order               Int
  users               User[]
  subModuleProgress   SubModuleProgress @relation(fields: [subModuleProgressId], references: [id], onDelete: Cascade)
}

model Badge {
  id                   String         @id @default(uuid())
  title                String
  locked_description   String
  unlocked_description String
  level                String // NOVICE, ADEPT, PROFICIENT, VIRTUOSO
  status               String         @default("LOCKED") //LOCKED, UNLOCKED
  moduleProgressId     String
  userId               String
  user                 User           @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  moduleProgress       ModuleProgress @relation(fields: [moduleProgressId], references: [id], onDelete: Cascade)
}

model Checkpoint {
  id                  String             @id @default(uuid())
  title               String
  score               Int                @default(0)
  status              String             @default("LOCKED") //LOCKED, IN_PROGRESS, SUBMITTED, GRADED, COMPLETED
  testEnvironment     String             @default("node") //node, browser
  gradingMethod       String             @default("AUTO") //AUTO, MANUAL
  moduleProgressId    String?            @unique
  subModuleProgressId String?            @unique
  users               User[]
  moduleProgress      ModuleProgress?    @relation(fields: [moduleProgressId], references: [id], onDelete: Cascade)
  subModuleProgress   SubModuleProgress? @relation(fields: [subModuleProgressId], references: [id], onDelete: Cascade)
  links               Link[]

  @@unique([moduleProgressId, subModuleProgressId])
}

model Test {
  id                  String             @id @default(uuid())
  title               String
  status              String             @default("LOCKED") //LOCKED, AVAILABLE  COMPLETED
  score               Int                @default(0)
  attempts            Int                @default(0)
  attempted           Boolean            @default(false)
  nextAttemptAt       DateTime?
  moduleProgressId    String?            @unique
  subModuleProgressId String?            @unique
  users               User[]
  moduleProgress      ModuleProgress?    @relation(fields: [moduleProgressId], references: [id], onDelete: Cascade)
  subModuleProgress   SubModuleProgress? @relation(fields: [subModuleProgressId], references: [id], onDelete: Cascade)
}

//||||||||||||||||##########||||||||||||||||//
//                 PROJECT                  //
//||||||||||||||||##########||||||||||||||||//

model Project {
  id               String         @id @default(uuid())
  title            String
  slug             String
  score            Int            @default(0)
  status           String         @default("LOCKED") //LOCKED, IN_PROGRESS, COMPLETED
  gradingMethod    String         @default("AUTO") //AUTO, MANUAL
  courseProgressId String         @unique
  contributors     User[]
  courseProgress   CourseProgress @relation(fields: [courseProgressId], references: [id], onDelete: Cascade)
  links            Link[]
}

model Link {
  id    String @id @default(uuid())
  title String
  url   String

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  checkpointId String?
  checkpoint   Checkpoint? @relation(fields: [checkpointId], references: [id], onDelete: Cascade)
}

model Event {
  id          String   @id @default(uuid())
  title       String
  type        String
  description String
  eventDate   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
